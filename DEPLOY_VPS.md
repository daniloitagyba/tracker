# VPS Deployment Guide (Ubuntu + PM2)

This guide explains how to deploy the Tracker application on an Ubuntu VPS using PM2 to manage processes and a custom port (e.g., 8080).

## 1. Prerequisites

Update your system and install Node.js, pnpm, and PM2:

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Node.js (LTS)
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# Install pnpm
sudo corepack enable
pnpm setup

# Install PM2
sudo npm install -g pm2
```

## 2. Project Setup

Clone the repository and install dependencies:

```bash
git clone <your-repo-url> tracker
cd tracker
pnpm install
```

## 3. Configuration

### Backend Setup

1. Create and configure the backend `.env` file:
```bash
cp backend/.env.example backend/.env
nano backend/.env
```

2. **Crucial:** Change the `PORT` and ensure the database path is correct for production.
```env
PORT=8080
DATABASE_URL="file:./prisma/prod.db"
# Fill other variables (Google OAuth, JWT, RapidAPI)
```

### Frontend Setup

1. Configure the frontend `.env` to point to your VPS IP or Domain:
```bash
cp frontend/.env.example frontend/.env
nano frontend/.env
```

2. Update `VITE_API_URL`:
```env
VITE_API_URL="http://your-vps-ip:8080"
```

## 4. Build the Application

From the root directory:

```bash
# Build both apps
pnpm build

# Initialize the production database
cd backend
npx prisma db push
cd ..
```

## 5. Deployment with PM2

We will use PM2 to run the backend. For the frontend, you have two options:

### Option A: Serve Frontend with Nginx (Recommended)

1. Install Nginx:
```bash
sudo apt install nginx
```

2. Copy the `frontend/dist` files to the web root:
```bash
sudo cp -r frontend/dist/* /var/www/html/
```

3. Start the Backend with PM2:
```bash
pm2 start backend/dist/server.js --name "tracker-api"
```

### Option B: Run everything via PM2 (Quick Start)

If you don't want to configure Nginx yet, you can use a simple static server for the frontend:

```bash
# Install a simple static server
sudo npm install -g serve

# Start Backend
pm2 start backend/dist/server.js --name "tracker-api"

# Start Frontend on a different port (e.g., 3000)
pm2 start "serve -s frontend/dist -l 3001" --name "tracker-web"
```

## 6. Persistence

Ensure PM2 starts automatically on system reboot:

```bash
pm2 save
pm2 startup
# Run the command generated by the output of 'pm2 startup'
```

## 7. Cloudflare Tunnel (Connector) Setup via GUI

Using Cloudflare Tunnel is more secure as it creates an outbound connection to Cloudflare, meaning you **don't** need to open any ports in your VPS firewall.

### 1. Install Cloudflared on VPS
Follow the instructions on the Cloudflare dashboard, or run:
```bash
curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared.deb
```

### 2. Configure via Cloudflare Zero Trust Dashboard
1. Go to **Zero Trust Dashboard** > **Networks** > **Tunnels**.
2. Click **Add a tunnel** and select **Cloudflared**.
3. Name your tunnel (e.g., `tracker-vps`) and Save.
4. Under **Install connector**, copy the command for your OS (Linux) and run it on your VPS. It will look like:
   `sudo cloudflared service install <TOKEN>`
5. Once the connector shows as **Healthy** in the dashboard, click **Next**.

### 3. Route Traffic (Public Hostnames)
Add two hostnames to your tunnel:

| Service | Public Hostname | Service Type | URL (Internal) |
| :--- | :--- | :--- | :--- |
| **Frontend** | `tracker.yourdomain.com` | `http` | `localhost:3002` (or `80` if using Nginx) |
| **Backend** | `api-tracker.yourdomain.com` | `http` | `localhost:8080` |

### 4. Update Frontend Environment Variables
Don't forget to rebuild your frontend with the new public API URL:
1. Update `frontend/.env`: `VITE_API_URL="https://api-tracker.yourdomain.com"`
2. Run `pnpm build` again.
3. Deploy the new `dist` folder.

## 8. Security (UFW)

Since you are using Cloudflare Tunnel, you can keep your firewall tight:

```bash
sudo ufw default deny incoming
sudo ufw allow ssh
sudo ufw enable
```
